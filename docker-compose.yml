version: '3.8'

services:
  backend:
    build: ./backend
    dockerfile: Dockerfile.prod
    expose:
      - "8000"
    environment:
      - PYTHONPATH=/app
      # These will be set by Coolify from environment variables
      - ENVIRONMENT
      - SECRET_KEY
      - DEBUG
      - SUPABASE_URL
      - SUPABASE_ANON_KEY
      - SUPABASE_SERVICE_KEY
      - DATABASE_URL
      - OPENAI_API_KEY
      - OPENAI_MODEL
      - OPENAI_MAX_TOKENS
      - OPENAI_TEMPERATURE
      - WHISPER_MODEL
      - TTS_MODEL
      - TTS_VOICE
      - STRIPE_SECRET_KEY
      - STRIPE_PUBLISHABLE_KEY
      - STRIPE_WEBHOOK_SECRET
      - STRIPE_PRICE_ID_PREMIUM
      - STRIPE_PRICE_ID_PREMIUM_YEARLY
      - ALLOWED_ORIGINS
      - BACKEND_URL
      - GOOGLE_CLIENT_ID
      - GOOGLE_CLIENT_SECRET
      - GOOGLE_REDIRECT_URI
      - SMTP_HOST
      - SMTP_PORT
      - SMTP_USERNAME
      - SMTP_PASSWORD
      - SMTP_USE_TLS
      - FROM_EMAIL
      - LOG_LEVEL
    volumes:
      - ./backend/static/uploads:/app/static/uploads
      - ./backend/data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    build: ./frontend
    expose:
      - "80"
    depends_on:
      - backend
    restart: unless-stopped
    environment:
      # These will be set by Coolify from environment variables
      - VITE_API_BASE_URL
      - VITE_SUPABASE_URL
      - VITE_SUPABASE_ANON_KEY
      - VITE_GOOGLE_CLIENT_ID
      - VITE_STRIPE_PUBLISHABLE_KEY

networks:
  default:
    driver: bridge